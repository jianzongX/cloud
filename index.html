<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 文件浏览器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .file-hover {
                @apply transition-all duration-200 hover:bg-primary/10 hover:-translate-y-1;
            }
            .file-card {
                @apply flex flex-col items-center justify-center p-4 rounded-lg border border-gray-100 w-full h-full;
            }
            .icon-large {
                font-size: 60px !important;
            }
            .folder-icon {
                font-size: 60px !important;
                color: #f59e0b !important;
            }
            .back-btn-hover {
                @apply transition-colors duration-200 hover:text-primary hover:bg-primary/5;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- 面包屑导航和返回按钮合并在一行 -->
            <div id="breadcrumb" class="p-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">当前路径:</span>
                    <span id="current-path" class="font-medium">根目录</span>
                </div>
                <!-- 返回上级按钮 -->
                <button id="back-btn" class="text-sm text-gray-600 back-btn-hover px-3 py-1 rounded border border-gray-200 opacity-50 cursor-not-allowed">
                    <i class="fa fa-arrow-left mr-1"></i>返回上级目录
                </button>
            </div>
            
            <div id="file-list" class="p-6">
                <div class="flex justify-center items-center h-40 text-gray-400">
                    <i class="fa fa-circle-o-notch fa-spin text-3xl mr-2"></i>
                    <span>正在加载文件列表...</span>
                </div>
            </div>
            
            <div id="error-message" class="p-6 hidden">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start">
                    <i class="fa fa-exclamation-circle text-red-500 text-xl mt-0.5 mr-3"></i>
                    <div>
                        <h3 class="font-medium text-red-800">加载失败</h3>
                        <p class="text-red-700 text-sm mt-1" id="error-details">无法加载文件列表，请检查文件路径是否正确。</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // GitHub仓库配置
        const GITHUB_USER = 'jianzongX';
        const GITHUB_REPO = 'cloud';
        const BRANCH = 'main';
        const ROOT_PATH = 'file'; // 实际根目录路径
        const ROOT_DISPLAY_NAME = '根目录'; // 根目录显示名称
        
        // 路径管理
        let currentPath = ROOT_PATH;  // 当前路径
        let pathSegments = [ROOT_PATH];  // 路径分段数组
        
        // DOM元素
        const fileListElement = document.getElementById('file-list');
        const errorMessageElement = document.getElementById('error-message');
        const errorDetailsElement = document.getElementById('error-details');
        const backBtn = document.getElementById('back-btn');
        const currentPathText = document.getElementById('current-path');
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', () => {
            fetchFileList(currentPath);
            backBtn.addEventListener('click', goBack);
        });
        
        /**
         * 获取文件列表
         */
        async function fetchFileList(targetPath) {
            showLoadingState();
            
            try {
                if (!isValidPath(targetPath)) {
                    throw new Error("路径包含非法字符");
                }
                
                const encodedPath = encodeURIComponent(targetPath).replace(/%2F/g, '/');
                const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${encodedPath}?ref=${BRANCH}`;
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                if (response.status === 404) {
                    throw new Error(`路径不存在: /${targetPath}`);
                }
                
                if (!response.ok) {
                    throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                }
                
                const items = await response.json();
                
                if (items.message) {
                    throw new Error(`API错误: ${items.message}`);
                }
                
                const folders = items.filter(item => item.type === 'dir');
                const files = items.filter(item => item.type === 'file');
                
                currentPath = targetPath;
                pathSegments = targetPath.split('/').filter(segment => segment);
                
                updatePathUI();
                displayItems(folders, files);
                
            } catch (error) {
                console.error('加载失败:', error);
                showError(`无法加载内容: ${error.message}`);
            }
        }
        
        /**
         * 返回上级目录
         */
        function goBack() {
            if (pathSegments.length <= 1) {
                console.log('已在根目录，无法返回');
                return;
            }
            
            try {
                pathSegments.pop();
                const parentPath = pathSegments.join('/');
                console.log('返回上级路径:', parentPath);
                fetchFileList(parentPath);
            } catch (error) {
                console.error('返回失败:', error);
                showError('返回上级目录时发生错误');
            }
        }
        
        /**
         * 更新路径UI显示 - 所有目录根目录左边都不加斜杠
         */
        function updatePathUI() {
            // 根目录直接显示"根目录"
            if (currentPath === ROOT_PATH && pathSegments.length === 1) {
                currentPathText.textContent = ROOT_DISPLAY_NAME;
            } else {
                // 子目录显示为"根目录/子目录1/子目录2"格式，根目录左侧无斜杠
                const displaySegments = pathSegments.map((segment, index) => {
                    return index === 0 ? ROOT_DISPLAY_NAME : segment;
                });
                currentPathText.textContent = displaySegments.join('/');
            }
            
            // 更新返回按钮状态
            const hasParent = pathSegments.length > 1;
            if (hasParent) {
                backBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                backBtn.classList.add('back-btn-hover');
                backBtn.disabled = false;
            } else {
                backBtn.classList.add('opacity-50', 'cursor-not-allowed');
                backBtn.classList.remove('back-btn-hover');
                backBtn.disabled = true;
            }
        }
        
        /**
         * 显示文件和文件夹
         */
        function displayItems(folders, files) {
            fileListElement.innerHTML = '';
            
            const totalCount = folders.length + files.length;
            
            if (totalCount === 0) {
                fileListElement.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fa fa-folder-open-o text-4xl mb-3"></i>
                        <p>文件夹为空</p>
                    </div>
                `;
                return;
            }
            
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4';
            
            // 添加文件夹
            folders.forEach(folder => {
                const folderCard = document.createElement('div');
                folderCard.className = 'file-hover aspect-square cursor-pointer';
                
                folderCard.innerHTML = `
                    <div class="file-card">
                        <div class="flex items-center justify-center h-3/4">
                            <i class="fa fa-folder folder-icon"></i>
                        </div>
                        <div class="h-1/4 flex items-center justify-center text-center px-2">
                            <span class="font-medium text-gray-800 text-sm truncate">${folder.name}</span>
                        </div>
                    </div>
                `;
                
                folderCard.addEventListener('click', () => {
                    const newPath = currentPath ? `${currentPath}/${folder.name}` : folder.name;
                    fetchFileList(newPath);
                });
                
                gridContainer.appendChild(folderCard);
            });
            
            // 添加文件
            files.forEach(file => {
                const fileUrl = `https://proxy.pipers.cn/https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/${file.path}`;
                const fileExtension = getFileExtension(file.name);
                const fileIcon = getFileIcon(fileExtension);
                
                const fileCard = document.createElement('a');
                fileCard.href = fileUrl;
                fileCard.download = file.name;
                fileCard.className = 'file-hover aspect-square';
                
                fileCard.innerHTML = `
                    <div class="file-card">
                        <div class="flex items-center justify-center h-3/4 text-primary">
                            <i class="fa ${fileIcon} icon-large"></i>
                        </div>
                        <div class="h-1/4 flex items-center justify-center text-center px-2">
                            <span class="font-medium text-gray-800 text-sm truncate">${file.name}</span>
                        </div>
                    </div>
                `;
                
                gridContainer.appendChild(fileCard);
            });
            
            fileListElement.appendChild(gridContainer);
        }
        
        /**
         * 辅助函数：验证路径
         */
        function isValidPath(path) {
            const invalidPatterns = /(\.\.\/|\.\/|~|\/\/)/;
            return !invalidPatterns.test(path);
        }
        
        /**
         * 辅助函数：显示加载状态
         */
        function showLoadingState() {
            errorMessageElement.classList.add('hidden');
            fileListElement.innerHTML = `
                <div class="flex justify-center items-center h-40 text-gray-400">
                    <i class="fa fa-circle-o-notch fa-spin text-3xl mr-2"></i>
                    <span>正在加载文件列表...</span>
                </div>
            `;
        }
        
        /**
         * 辅助函数：显示错误
         */
        function showError(message) {
            errorDetailsElement.textContent = message;
            errorMessageElement.classList.remove('hidden');
            fileListElement.innerHTML = '';
        }
        
        /**
         * 辅助函数：获取文件扩展名
         */
        function getFileExtension(fileName) {
            const parts = fileName.split('.');
            return parts.length > 1 ? parts.pop().toLowerCase() : '';
        }
        
        /**
         * 辅助函数：获取文件图标
         */
        function getFileIcon(extension) {
            const iconMap = {
                'pdf': 'fa-file-pdf-o',
                'doc': 'fa-file-word-o',
                'docx': 'fa-file-word-o',
                'xls': 'fa-file-excel-o',
                'xlsx': 'fa-file-excel-o',
                'ppt': 'fa-file-powerpoint-o',
                'pptx': 'fa-file-powerpoint-o',
                'txt': 'fa-file-text-o',
                'md': 'fa-file-text-o',
                'jpg': 'fa-file-image-o',
                'jpeg': 'fa-file-image-o',
                'png': 'fa-file-image-o',
                'gif': 'fa-file-image-o',
                'svg': 'fa-file-image-o',
                'zip': 'fa-file-zip-o',
                'rar': 'fa-file-zip-o',
                'html': 'fa-file-code-o',
                'css': 'fa-file-code-o',
                'js': 'fa-file-code-o',
                'py': 'fa-file-code-o',
                'json': 'fa-file-code-o'
            };
            return iconMap[extension] || 'fa-file-o';
        }
    </script>
</body>
</html>